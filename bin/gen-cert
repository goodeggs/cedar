#!/bin/bash
set -e
set -o pipefail
# set -x # debug

AWS_REGION=$1

if [ "$AWS_REGION" == "" ]; then
  echo "usage: gen-cert <AWS Region>"
  exit 1
fi

dest=`mktemp -d`

cd $dest

openssl req -new -newkey rsa:2048 -days 365 -nodes -x509 \
  -subj "/C=US/ST=California/L=San Francisco/O=Good Eggs/OU=DevOps/CN=*.${AWS_REGION}.elb.amazonaws.com" \
  -keyout server.key -out server.crt 2>/dev/null

# echos a combined PEM like haproxy wants
cat server.crt server.key

# cleanup
rm -rf $dest
